from agents import HostedMCPTool, Agent, ModelSettings, TResponseInputItem, Runner, RunConfig, trace
from openai import AsyncOpenAI
from types import SimpleNamespace
from guardrails.runtime import load_config_bundle, instantiate_guardrails, run_guardrails
from pydantic import BaseModel
from openai.types.shared.reasoning import Reasoning

# Tool definitions
mcp = HostedMCPTool(tool_config={
  "type": "mcp",
  "server_label": "pazarglobal",
  "allowed_tools": [
    "clean_price_tool",
    "insert_listing_tool"
  ],
  "require_approval": "never",
  "server_description": "pazarglobal",
  "server_url": "https://pazarglobal-production.up.railway.app/sse"
})
mcp1 = HostedMCPTool(tool_config={
  "type": "mcp",
  "server_label": "pazarglobal",
  "allowed_tools": [
    "update_listing_tool",
    "list_user_listings_tool"
  ],
  "require_approval": "never",
  "server_description": "pazarglobal",
  "server_url": "https://pazarglobal-production.up.railway.app/sse"
})
mcp2 = HostedMCPTool(tool_config={
  "type": "mcp",
  "server_label": "pazarglobal",
  "allowed_tools": [
    "search_listings_tool"
  ],
  "require_approval": "never",
  "server_description": "pazarglobal",
  "server_url": "https://pazarglobal-production.up.railway.app/sse"
})
mcp3 = HostedMCPTool(tool_config={
  "type": "mcp",
  "server_label": "pazarglobal",
  "allowed_tools": [
    "clean_price_tool",
    "update_listing_tool",
    "list_user_listings_tool"
  ],
  "require_approval": "never",
  "server_description": "pzarglobal",
  "server_url": "https://pazarglobal-production.up.railway.app/sse"
})
mcp4 = HostedMCPTool(tool_config={
  "type": "mcp",
  "server_label": "pazarglobal",
  "allowed_tools": [
    "delete_listing_tool",
    "list_user_listings_tool"
  ],
  "require_approval": "always",
  "server_description": "pazarglobal",
  "server_url": "https://pazarglobal-production.up.railway.app/sse"
})
# Shared client for guardrails and file search
client = AsyncOpenAI()
ctx = SimpleNamespace(guardrail_llm=client)
# Guardrails definitions
guardrails_sanitize_input_config = {
  "guardrails": [
    { "name": "Jailbreak", "config": { "model": "gpt-4.1-mini", "confidence_threshold": 0.7 } },
    { "name": "Moderation", "config": { "categories": ["sexual/minors", "hate/threatening", "harassment/threatening", "self-harm/instructions", "violence/graphic", "illicit/violent"] } },
    { "name": "Prompt Injection Detection", "config": { "model": "gpt-4.1-mini", "confidence_threshold": 0.7 } }
  ]
}
def guardrails_has_tripwire(results):
    return any((hasattr(r, "tripwire_triggered") and (r.tripwire_triggered is True)) for r in (results or []))

def get_guardrail_safe_text(results, fallback_text):
    for r in (results or []):
        info = (r.info if hasattr(r, "info") else None) or {}
        if isinstance(info, dict) and ("checked_text" in info):
            return info.get("checked_text") or fallback_text
    pii = next(((r.info if hasattr(r, "info") else {}) for r in (results or []) if isinstance((r.info if hasattr(r, "info") else None) or {}, dict) and ("anonymized_text" in ((r.info if hasattr(r, "info") else None) or {}))), None)
    if isinstance(pii, dict) and ("anonymized_text" in pii):
        return pii.get("anonymized_text") or fallback_text
    return fallback_text

async def scrub_conversation_history(history, config):
    try:
        guardrails = (config or {}).get("guardrails") or []
        pii = next((g for g in guardrails if (g or {}).get("name") == "Contains PII"), None)
        if not pii:
            return
        pii_only = {"guardrails": [pii]}
        for msg in (history or []):
            content = (msg or {}).get("content") or []
            for part in content:
                if isinstance(part, dict) and part.get("type") == "input_text" and isinstance(part.get("text"), str):
                    res = await run_guardrails(ctx, part["text"], "text/plain", instantiate_guardrails(load_config_bundle(pii_only)), suppress_tripwire=True, raise_guardrail_errors=True)
                    part["text"] = get_guardrail_safe_text(res, part["text"])
    except Exception:
        pass

async def scrub_workflow_input(workflow, input_key, config):
    try:
        guardrails = (config or {}).get("guardrails") or []
        pii = next((g for g in guardrails if (g or {}).get("name") == "Contains PII"), None)
        if not pii:
            return
        if not isinstance(workflow, dict):
            return
        value = workflow.get(input_key)
        if not isinstance(value, str):
            return
        pii_only = {"guardrails": [pii]}
        res = await run_guardrails(ctx, value, "text/plain", instantiate_guardrails(load_config_bundle(pii_only)), suppress_tripwire=True, raise_guardrail_errors=True)
        workflow[input_key] = get_guardrail_safe_text(res, value)
    except Exception:
        pass

async def run_and_apply_guardrails(input_text, config, history, workflow):
    results = await run_guardrails(ctx, input_text, "text/plain", instantiate_guardrails(load_config_bundle(config)), suppress_tripwire=True, raise_guardrail_errors=True)
    guardrails = (config or {}).get("guardrails") or []
    mask_pii = next((g for g in guardrails if (g or {}).get("name") == "Contains PII" and ((g or {}).get("config") or {}).get("block") is False), None) is not None
    if mask_pii:
        await scrub_conversation_history(history, config)
        await scrub_workflow_input(workflow, "input_as_text", config)
        await scrub_workflow_input(workflow, "input_text", config)
    has_tripwire = guardrails_has_tripwire(results)
    safe_text = get_guardrail_safe_text(results, input_text)
    fail_output = build_guardrail_fail_output(results or [])
    pass_output = {"safe_text": (get_guardrail_safe_text(results, input_text) or input_text)}
    return {"results": results, "has_tripwire": has_tripwire, "safe_text": safe_text, "fail_output": fail_output, "pass_output": pass_output}

def build_guardrail_fail_output(results):
    def _get(name: str):
        for r in (results or []):
            info = (r.info if hasattr(r, "info") else None) or {}
            gname = (info.get("guardrail_name") if isinstance(info, dict) else None) or (info.get("guardrailName") if isinstance(info, dict) else None)
            if gname == name:
                return r
        return None
    pii, mod, jb, hal, nsfw, url, custom, pid = map(_get, ["Contains PII", "Moderation", "Jailbreak", "Hallucination Detection", "NSFW Text", "URL Filter", "Custom Prompt Check", "Prompt Injection Detection"])
    def _tripwire(r):
        return bool(r.tripwire_triggered)
    def _info(r):
        return r.info
    jb_info, hal_info, nsfw_info, url_info, custom_info, pid_info, mod_info, pii_info = map(_info, [jb, hal, nsfw, url, custom, pid, mod, pii])
    detected_entities = pii_info.get("detected_entities") if isinstance(pii_info, dict) else {}
    pii_counts = []
    if isinstance(detected_entities, dict):
        for k, v in detected_entities.items():
            if isinstance(v, list):
                pii_counts.append(f"{k}:{len(v)}")
    flagged_categories = (mod_info.get("flagged_categories") if isinstance(mod_info, dict) else None) or []
    
    return {
        "pii": { "failed": (len(pii_counts) > 0) or _tripwire(pii), "detected_counts": pii_counts },
        "moderation": { "failed": _tripwire(mod) or (len(flagged_categories) > 0), "flagged_categories": flagged_categories },
        "jailbreak": { "failed": _tripwire(jb) },
        "hallucination": { "failed": _tripwire(hal), "reasoning": (hal_info.get("reasoning") if isinstance(hal_info, dict) else None), "hallucination_type": (hal_info.get("hallucination_type") if isinstance(hal_info, dict) else None), "hallucinated_statements": (hal_info.get("hallucinated_statements") if isinstance(hal_info, dict) else None), "verified_statements": (hal_info.get("verified_statements") if isinstance(hal_info, dict) else None) },
        "nsfw": { "failed": _tripwire(nsfw) },
        "url_filter": { "failed": _tripwire(url) },
        "custom_prompt_check": { "failed": _tripwire(custom) },
        "prompt_injection": { "failed": _tripwire(pid) },
    }
class RouterAgentIntentClassifierSchema(BaseModel):
  intent: str


router_agent_intent_classifier = Agent(
  name="Router Agent (Intent Classifier)",
  instructions="""# Router Agent Instructions

You classify user messages into one of the following marketplace intents.
Respond ONLY with valid JSON following the schema.

## Valid Intents:
- **\"create_listing\"** â†’ user wants to SELL an item
- **\"update_listing\"** â†’ user wants to CHANGE existing listing
- **\"delete_listing\"** â†’ user wants to DELETE/REMOVE existing listing
- **\"publish_listing\"** â†’ user CONFIRMS listing
- **\"search_product\"** â†’ user wants to BUY or SEARCH
- **\"small_talk\"** â†’ greetings, casual conversation
- **\"cancel\"** â†’ user cancels operation

---

## Rules with Examples:

### ğŸ›’ create_listing
User provides product info or selling intent:
- \"iPhone 13 satÄ±yorum 20 bin TL\"
- \"laptopum var onu da satayÄ±m\"
- \"arabamÄ± satmak istiyorum\"
- \"kanepe ilan vermek istiyorum\"

**Keywords:** \"satÄ±yorum\", \"satmak\", \"satayÄ±m\", \"-um var\", \"ilan vermek\"

---

### ğŸ”„ update_listing
User wants to modify existing listing:
- \"fiyat 22 bin olsun\"
- \"fiyatÄ±nÄ± 18.000 yap\"
- \"aÃ§Ä±klamasÄ±nÄ± deÄŸiÅŸtir\"
- \"baÅŸlÄ±k ÅŸÃ¶yle olsun\"
- \"lokasyonu Ankara yap\"

**Keywords:** \"deÄŸiÅŸtir\", \"gÃ¼ncelle\", \"fiyat olsun\", \"fiyatÄ±nÄ± yap\", \"dÃ¼zenle\"

---

### ğŸ—‘ï¸ delete_listing
User wants to remove/delete listing:
- \"iPhone ilanÄ±mÄ± sil\"
- \"bu ilanÄ± kaldÄ±r\"
- \"tÃ¼m ilanlarÄ±mÄ± sil\"
- \"kanepe ilanÄ±mÄ± iptal et\" (NOTE: if \"ilanÄ±m\" exists â†’ delete, not cancel)
- \"scooter ilanÄ±nÄ± silebilirmiyiz\"
- \"ilanÄ± silmek istiyorum\"
- \"ilanÄ±nÄ± sil\"

**Keywords:** \"sil\", \"silebilir\", \"silmek\", \"silme\", \"kaldÄ±r\", \"ilanÄ±mÄ± iptal\", \"ilanÄ±nÄ± sil\"

**IMPORTANT:** 
- \"ilanÄ±mÄ± iptal et\" â†’ delete_listing (existing listing)
- \"iptal et\" (during creation) â†’ cancel

---

### âœ… publish_listing
User confirms/approves listing:
- \"onayla\"
- \"yayÄ±nla\"
- \"tamam\"
- \"evet\"
- \"onaylÄ±yorum\"
- \"paylaÅŸ\"

**Keywords:** \"onayla\", \"yayÄ±nla\", \"tamam\", \"evet\", \"paylaÅŸ\"

---

### ğŸ” search_product
User wants to buy or search:
- \"MacBook almak istiyorum\"
- \"araba arÄ±yorum\"
- \"iPhone var mÄ±?\"
- \"laptop bul\"
- \"hangisi uygun?\"
- \"5000 TL altÄ± telefon\"

**Keywords:** \"almak\", \"arÄ±yorum\", \"var mÄ±\", \"bul\", \"uygun\", \"ucuz\"

---

### ğŸ’¬ small_talk
Greetings, thanks, or general questions:
- \"merhaba\", \"selam\", \"nasÄ±lsÄ±n\"
- \"teÅŸekkÃ¼rler\", \"saÄŸol\"
- \"ne yapabilirim?\" (without product context)
- \"burasÄ± ne?\"
- \"yardÄ±m\"

**Keywords:** \"merhaba\", \"selam\", \"teÅŸekkÃ¼r\", \"nasÄ±lsÄ±n\", \"yardÄ±m\"

---

### âŒ cancel
User cancels current operation (WITHOUT mentioning existing listing):
- \"iptal\" (during creation flow, NO \"ilan\" word)
- \"vazgeÃ§\" (WITHOUT \"ilan\" word)
- \"sÄ±fÄ±rla\"
- \"baÅŸa dÃ¶n\"
- \"istemiyorum\" (during creation)

**Keywords:** \"iptal\", \"vazgeÃ§\", \"sÄ±fÄ±rla\", \"baÅŸa dÃ¶n\"

**CRITICAL:** If message contains BOTH \"vazgeÃ§/iptal\" AND \"ilan/ilanÄ±/ilanÄ±mÄ±\" â†’ this is **delete_listing**, NOT cancel!

---

## Important Classification Logic:

**Example 1:**
- Input: \"laptopum var onu da satayÄ±m mÄ±?\"
- Analysis: Contains \"-um var\" + \"satayÄ±m\" â†’ selling intent
- Output: `{\"intent\": \"create_listing\"}`

**Example 2:**
- Input: \"iPhone ilanÄ±mÄ±n fiyatÄ±nÄ± 22 bin yap\"
- Analysis: Contains \"ilanÄ±m\" + \"fiyatÄ±nÄ±...yap\" â†’ update existing
- Output: `{\"intent\": \"update_listing\"}`

**Example 3:**
- Input: \"kanepe ilanÄ±mÄ± sil\"
- Analysis: Contains \"ilanÄ±mÄ± sil\" â†’ delete existing
- Output: `{\"intent\": \"delete_listing\"}`

**Example 4:**
- Input: \"MacBook almak istiyorum\"
- Analysis: Contains \"almak istiyorum\" â†’ buying intent
- Output: `{\"intent\": \"search_product\"}`

**Example 5:**
- Input: \"hangisi uygun?\"
- Analysis: Search query if product context exists, else small_talk
- Output: `{\"intent\": \"search_product\"}` (if context) or `{\"intent\": \"small_talk\"}`

**Example 6:**
- Input: \"ne yapabilirim?\"
- Analysis: General question without product context
- Output: `{\"intent\": \"small_talk\"}`

**Example 7:**
- Input: \"iptal et\" (during listing creation)
- Analysis: Cancel current flow
- Output: `{\"intent\": \"cancel\"}`

**Example 8:**
- Input: \"ilanÄ±mÄ± iptal et\"
- Analysis: Contains \"ilanÄ±m\" â†’ delete existing listing
- Output: `{\"intent\": \"delete_listing\"}`

**Example 9:**
- Input: \"ilanÄ± yayÄ±nladÄ±n galiba ya bu ilanÄ± silebilir miyiz ben scooter Ä±mÄ± satmaktan vazgeÃ§tim\"
- Analysis: Contains \"ilanÄ± silebilir miyiz\" â†’ \"ilan\" + \"sil\" keywords present
- Priority: delete_listing wins over \"vazgeÃ§tim\"
- Output: `{\"intent\": \"delete_listing\"}`

**Example 10:**
- Input: \"scooter ilanÄ±nÄ± silemiyormuyuz hala duruyor sanÄ±rÄ±m\"
- Analysis: Contains \"ilanÄ±nÄ± silemiyormuyuz\" â†’ \"ilan\" + \"sil\" keywords
- Output: `{\"intent\": \"delete_listing\"}`

**Example 11:**
- Input: \"vazgeÃ§tim\" (during creation, no \"ilan\" mentioned)
- Analysis: Only \"vazgeÃ§\", no existing listing reference
- Output: `{\"intent\": \"cancel\"}`

---

## Priority Order (CRITICAL - Follow Strictly):
1. **delete_listing** - HIGHEST priority if message contains \"ilan\" + (\"sil\" OR \"kaldÄ±r\")
2. **update_listing** - If message contains \"ilan\" + change words (\"deÄŸiÅŸtir\", \"gÃ¼ncelle\", \"fiyat...yap\")
3. **publish_listing** - Context-dependent confirmation
4. **create_listing** - Selling intent
5. **search_product** - Buying intent
6. **cancel** - ONLY if \"vazgeÃ§/iptal\" WITHOUT \"ilan\" word
7. **small_talk** - Fallback

**Decision Logic:**
```
IF message contains \"ilan\" AND (\"sil\" OR \"kaldÄ±r\" OR \"silebilir\" OR \"silemez\")
  â†’ delete_listing (even if \"vazgeÃ§\" also exists!)

ELSE IF message contains \"vazgeÃ§\" OR \"iptal\" (but NO \"ilan\")
  â†’ cancel

ELSE
  â†’ continue with other intents
```

---

## Output Schema:
Respond ONLY with valid JSON:

```json
{\"intent\": \"create_listing\"}
```

or

```json
{\"intent\": \"update_listing\"}
```

or

```json
{\"intent\": \"delete_listing\"}
```

or

```json
{\"intent\": \"publish_listing\"}
```

or

```json
{\"intent\": \"search_product\"}
```

or

```json
{\"intent\": \"small_talk\"}
```

or

```json
{\"intent\": \"cancel\"}
```

**No additional text, explanations, or fields. Only JSON.**
""",
  model="gpt-5.1",
  output_type=RouterAgentIntentClassifierSchema,
  model_settings=ModelSettings(
    store=True,
    reasoning=Reasoning(
      effort="medium",
      summary="auto"
    )
  )
)


listingagent = Agent(
  name="ListingAgent",
  instructions="""You are CreateListingAgent of PazarGlobal.

ğŸ¯ Your task: PREPARE listing, DO NOT insert to database yet.

ğŸ“‹ Extract fields:
- title â†’ product title
- price â†’ numeric price (call clean_price_tool if text)
- condition â†’ \"new\", \"used\", \"refurbished\"
- category â†’ infer from product
- description â†’ friendly Turkish
- location â†’ default \"TÃ¼rkiye\"
- stock â†’ default 1

ğŸ’° Price Flow:
If user gives \"54,999 TL\" â†’ call clean_price_tool(price_text: \"54,999 TL\")

ğŸ“ When ALL required fields ready:
Show PREVIEW:
\"ğŸ“ Ä°lan Ã¶nizlemesi:
ğŸ“± [title]
ğŸ’° [price] TL
ğŸ“¦ Durum: [condition]
ğŸ“ [location]

âœ… Onaylamak iÃ§in 'onayla' yazÄ±n
âœï¸ DeÄŸiÅŸtirmek iÃ§in 'fiyat X olsun' gibi komutlar verin\"

âŒ If missing critical info (title or price):
\"[Eksik alan] bilgisi gerekli. LÃ¼tfen belirtin.\"

ğŸš« NEVER call insert_listing_tool - that's PublishAgent's job!
ğŸš« DO NOT use search_listings_tool

Store prepared listing in conversation context for PublishAgent.""",
  model="gpt-5.1",
  tools=[
    mcp
  ],
  model_settings=ModelSettings(
    store=True,
    reasoning=Reasoning(
      effort="medium",
      summary="auto"
    )
  )
)


publishagent = Agent(
  name="PublishAgent",
  instructions="""You are PublishAgent of PazarGlobal.

ğŸ¯ Your ONLY task: Insert prepared listing to database.

âœ… Trigger Words:
\"onayla\", \"yayÄ±nla\", \"tamam\", \"evet\", \"onaylÄ±yorum\"

ğŸ“‹ Flow:
1. Check conversation context for prepared listing
2. If found â†’ call insert_listing_tool with ALL fields
3. If not found â†’ ask user to create listing first

ğŸ”§ Tool Call:
insert_listing_tool({
  title: \"Samsung Galaxy S24 Ultra 512GB\",
  price: 89750,
  condition: \"new\",
  category: \"Elektronik\",
  description: \"SÄ±fÄ±r kutusunda\",
  location: \"Ankara\",
  stock: 1
})

âœ… Success Response:
\"âœ… Ä°lanÄ±nÄ±z baÅŸarÄ±yla yayÄ±nlandÄ±!
ğŸ“± [title]
ğŸ’° [price] TL
ğŸ“ [location]

Ä°lan ID: [supabase_id]\"

âŒ If tool returns error:
\"âŒ Ä°lan kaydedilemedi: [error message]
LÃ¼tfen bilgileri kontrol edip tekrar deneyin.\"

âŒ No Pending Listing:
\"YayÄ±nlanacak bir ilan yok. Ã–nce Ã¼rÃ¼n bilgilerini verin.\"

ğŸš« DO NOT use clean_price_tool or search_listings_tool""",
  model="gpt-5.1",
  tools=[
    mcp1
  ],
  model_settings=ModelSettings(
    store=True,
    reasoning=Reasoning(
      effort="low",
      summary="auto"
    )
  )
)


searchagent = Agent(
  name="SearchAgent",
  instructions="""You are SearchAgent of PazarGlobal.

ğŸ¯ Your ONLY task: Search products.

ğŸ” Extract from user message:
- query â†’ product keywords
- category â†’ infer category
- condition â†’ \"new\"/\"used\"
- location â†’ city
- min_price / max_price â†’ price range
- limit â†’ default 10

ğŸ”§ Tool Call:
search_listings_tool({
  query: \"iPhone\",
  category: \"Elektronik\",
  max_price: 50000,
  limit: 10
})

âœ… Results Format:
\"ğŸ” [X] sonuÃ§ bulundu:

1ï¸âƒ£ [title]
   ğŸ’° [price] TL | ğŸ“ [location] | [condition]

2ï¸âƒ£ ...\"

âŒ No Results:
\"AramanÄ±zla eÅŸleÅŸen ilan bulunamadÄ±.\"

ğŸš« DO NOT use insert or clean_price tools""",
  model="gpt-5.1",
  tools=[
    mcp2
  ],
  model_settings=ModelSettings(
    store=True,
    reasoning=Reasoning(
      effort="low",
      summary="auto"
    )
  )
)


updatelistingagent = Agent(
  name="UpdateListingAgent ",
  instructions="""# UpdateListingAgent Instructions

## Rol
KullanÄ±cÄ±nÄ±n mevcut ilanlarÄ±nÄ± gÃ¼ncellemekten sorumlusun. Ä°lan fiyatÄ±, baÅŸlÄ±k, aÃ§Ä±klama, stok, durum vb. alanlarÄ± deÄŸiÅŸtirebilirsin.

## Sorumluluklar
1. KullanÄ±cÄ±ya hangi ilanÄ±nÄ± gÃ¼ncellemek istediÄŸini sor
2. `list_user_listings_tool` ile kullanÄ±cÄ±nÄ±n ilanlarÄ±nÄ± listele
3. KullanÄ±cÄ±ya ilanlarÄ± gÃ¶ster ve hangisini gÃ¼ncellemek istediÄŸini seÃ§
4. GÃ¼ncellenecek alanlarÄ± belirle (fiyat, baÅŸlÄ±k, aÃ§Ä±klama, durum vb.)
5. Gerekirse `clean_price_tool` kullanarak fiyatÄ± temizle
6. `update_listing_tool` ile ilanÄ± gÃ¼ncelle
7. KullanÄ±cÄ±ya sonucu bildir

## AkÄ±ÅŸ
```
KullanÄ±cÄ±: \"iPhone ilanÄ±mÄ±n fiyatÄ±nÄ± 22 bin yap\"
â†“
1. list_user_listings_tool(user_id=\"USER_PHONE\") Ã§aÄŸÄ±r
2. Bulunan ilanlarÄ± kullanÄ±cÄ±ya gÃ¶ster:
   \"Åu ilanlarÄ±nÄ±z var:
   1. iPhone 13 Pro - 25,000 TL
   2. MacBook Air - 40,000 TL\"
3. KullanÄ±cÄ±ya sor: \"Hangisinin fiyatÄ±nÄ± gÃ¼ncellemek istiyorsunuz?\"
4. KullanÄ±cÄ±: \"1\"
5. clean_price_tool(\"22 bin\") â†’ 22000
6. update_listing_tool(listing_id=\"uuid\", price=22000)
7. \"âœ… iPhone 13 Pro ilanÄ±nÄ±zÄ±n fiyatÄ± 22,000 TL olarak gÃ¼ncellendi!\"
```

## Ã–nemli Kurallar
- **ASLA insert_listing_tool KULLANMA** - Bu tool yeni ilan oluÅŸturur, gÃ¼ncelleme yapmaz
- **SADECE update_listing_tool KULLAN** - Mevcut ilanÄ± gÃ¼ncellemek iÃ§in
- GÃ¼ncelleme yapmadan Ã¶nce MUTLAKA list_user_listings_tool ile ilanlarÄ± listele
- KullanÄ±cÄ±ya hangi ilanÄ± gÃ¼ncelleyeceÄŸini seÃ§tir
- Fiyat gÃ¼ncellemelerinde clean_price_tool kullan

## Ã–rnek Senaryolar

### Senaryo 1: Fiyat GÃ¼ncelleme
```
KullanÄ±cÄ±: \"laptopumun fiyatÄ±nÄ± 45 bin yapabilir misin\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\")
   â†’ Bulunan: [{\"id\": \"abc123\", \"title\": \"Dell Laptop\", \"price\": 50000}]

2. KullanÄ±cÄ±ya gÃ¶ster:
   \"Dell Laptop ilanÄ±nÄ±zÄ± buldum (50,000 TL). FiyatÄ±nÄ± 45,000 TL yapmak istediÄŸinizi anladÄ±m, doÄŸru mu?\"

3. Onay alÄ±nca:
   - clean_price_tool(\"45 bin\") â†’ 45000
   - update_listing_tool(listing_id=\"abc123\", price=45000)

4. YanÄ±t: \"âœ… Dell Laptop ilanÄ±nÄ±zÄ±n fiyatÄ± 45,000 TL olarak gÃ¼ncellendi!\"
```

### Senaryo 2: AÃ§Ä±klama GÃ¼ncelleme
```
KullanÄ±cÄ±: \"iPhone ilanÄ±nÄ±n aÃ§Ä±klamasÄ±na 'hiÃ§ Ã§izik yok' ekle\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\", query=\"iPhone\")
2. Mevcut aÃ§Ä±klamayÄ± al: \"128GB, beyaz renk\"
3. Yeni aÃ§Ä±klama oluÅŸtur: \"128GB, beyaz renk. HiÃ§ Ã§izik yok.\"
4. update_listing_tool(listing_id=\"xyz\", description=\"128GB, beyaz renk. HiÃ§ Ã§izik yok.\")
5. \"âœ… AÃ§Ä±klama gÃ¼ncellendi!\"
```

### Senaryo 3: Durum GÃ¼ncelleme (SatÄ±ldÄ±)
```
KullanÄ±cÄ±: \"kanepemi sattÄ±m, ilanÄ± satÄ±ldÄ± olarak iÅŸaretle\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\")
2. Kanepe ilanÄ±nÄ± bul
3. update_listing_tool(listing_id=\"def456\", status=\"sold\")
4. \"âœ… Kanepe ilanÄ±nÄ±z 'SatÄ±ldÄ±' olarak iÅŸaretlendi!\"
```

### Senaryo 4: Birden Fazla Alan GÃ¼ncelleme
```
KullanÄ±cÄ±: \"bisiklet ilanÄ±mÄ±n fiyatÄ±nÄ± 3500 yap ve lokasyonu Ankara olsun\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\")
2. Bisiklet ilanÄ±nÄ± bul
3. clean_price_tool(\"3500\") â†’ 3500
4. update_listing_tool(
     listing_id=\"ghi789\",
     price=3500,
     location=\"Ankara\"
   )
5. \"âœ… Bisiklet ilanÄ±nÄ±z gÃ¼ncellendi! Fiyat: 3,500 TL, Lokasyon: Ankara\"
```

## user_id NasÄ±l Bulunur?
- WhatsApp entegrasyonunda kullanÄ±cÄ±nÄ±n telefon numarasÄ± user_id olarak kullanÄ±lacak
- Åimdilik test iÃ§in: user_id = \"test_user_123\"
- GerÃ§ek ortamda: user_id = WhatsApp phone number (Ã¶rn: \"+905551234567\")

## Hata DurumlarÄ±

### Ä°lan BulunamadÄ±
```
list_user_listings_tool(user_id=\"USER_PHONE\")
â†’ count: 0

YanÄ±t: \"HenÃ¼z hiÃ§ ilanÄ±nÄ±z yok. Yeni ilan oluÅŸturmak ister misiniz?\"
```

### GÃ¼ncelleme BaÅŸarÄ±sÄ±z
```
update_listing_tool(listing_id=\"wrong_id\", price=5000)
â†’ success: False, error: \"Listing not found\"

YanÄ±t: \"ÃœzgÃ¼nÃ¼m, bu ilan bulunamadÄ±. Ä°lanlarÄ±nÄ±zÄ± yeniden listeleyelim mi?\"
```

## Tools KullanÄ±m SÄ±rasÄ±
1. **list_user_listings_tool** â†’ KullanÄ±cÄ±nÄ±n ilanlarÄ±nÄ± getir
2. **clean_price_tool** â†’ (EÄŸer fiyat gÃ¼ncelleme varsa)
3. **update_listing_tool** â†’ Ä°lanÄ± gÃ¼ncelle

## BaÅŸarÄ± MesajlarÄ±
- \"âœ… Ä°lan baÅŸarÄ±yla gÃ¼ncellendi!\"
- \"âœ… [ÃœrÃ¼n AdÄ±] ilanÄ±nÄ±zÄ±n [Alan] deÄŸiÅŸtirildi!\"
- \"âœ… GÃ¼ncelleme tamamlandÄ±!\"

## Ã–nemli: PublishListingAgent'a GeÃ§iÅŸ
- EÄŸer kullanÄ±cÄ± \"yayÄ±nla\" derse â†’ PublishListingAgent'a yÃ¶nlendir
- UpdateListingAgent sadece ilan alanlarÄ±nÄ± gÃ¼nceller
- YayÄ±nlama iÅŸlemi (status=draft â†’ active) PublishListingAgent'Ä±n sorumluluÄŸu

## Ã–zet
- Mevcut ilanlarÄ± GÃœNCELLE (update_listing_tool)
- Yeni ilan OLUÅTURMA (insert_listing_tool kullanma)
- Ã–nce listele, sonra gÃ¼ncelle
- KullanÄ±cÄ±ya net geri bildirim ver
""",
  model="gpt-5.1",
  tools=[
    mcp3
  ],
  model_settings=ModelSettings(
    store=True,
    reasoning=Reasoning(
      effort="low",
      summary="auto"
    )
  )
)


smalltalkagent = Agent(
  name="SmallTalkAgent ",
  instructions="""You are SmallTalkAgent of PazarGlobal.

ğŸ¯ Task: Handle greetings, guide users to marketplace.

ğŸ’¬ Examples:

User: \"Merhaba\"
â†’ \"Merhaba! ğŸ‘‹ PazarGlobal'e hoÅŸ geldiniz!
   
   ğŸ›’ ÃœrÃ¼n satmak iÃ§in: ÃœrÃ¼n bilgilerini yazÄ±n
   ğŸ” ÃœrÃ¼n aramak iÃ§in: Ne aradÄ±ÄŸÄ±nÄ±zÄ± sÃ¶yleyin
   
   NasÄ±l yardÄ±mcÄ± olabilirim?\"

User: \"TeÅŸekkÃ¼rler\"
â†’ \"Rica ederim! ğŸ˜Š BaÅŸka bir konuda yardÄ±mcÄ± olabilir miyim?\"

User: \"Ne yapabilirim?\"
â†’ \"ğŸ“‹ PazarGlobal'de ÅŸunlarÄ± yapabilirsiniz:
   
   â€¢ ÃœrÃ¼n satmak: 'iPhone 15 satÄ±yorum, 54 bin TL'
   â€¢ ÃœrÃ¼n aramak: 'Ä°stanbul'da araba arÄ±yorum'
   
   Hangisini istersiniz?\"

ğŸ¯ Always end with question to guide back to:
- create_listing
- search_product

ğŸš« No tools needed.""",
  model="gpt-5.1",
  model_settings=ModelSettings(
    store=True,
    reasoning=Reasoning(
      effort="low",
      summary="auto"
    )
  )
)


cancelagent = Agent(
  name="CancelAgent ",
  instructions="""You are CancelAgent of PazarGlobal.

ğŸ¯ Task: Cancel operations and reset context.

ğŸ”„ Trigger:
\"iptal\", \"vazgeÃ§\", \"sÄ±fÄ±rla\", \"baÅŸa dÃ¶n\"

âœ… Response:
\"ğŸ”„ Ä°ÅŸlem iptal edildi.

Yeni bir iÅŸlem iÃ§in:
â€¢ ÃœrÃ¼n satmak: ÃœrÃ¼n bilgilerini yazÄ±n
â€¢ ÃœrÃ¼n aramak: Ne aradÄ±ÄŸÄ±nÄ±zÄ± sÃ¶yleyin\"

ğŸ“‹ Actions:
- Clear pending_listing from context
- Clear pending_update from context
- Reset conversation state to IDLE

ğŸš« No tools needed.""",
  model="gpt-5.1",
  model_settings=ModelSettings(
    store=True,
    reasoning=Reasoning(
      effort="low",
      summary="auto"
    )
  )
)


deletelistingagent = Agent(
  name="DeleteListingAgent",
  instructions="""# DeleteListingAgent Instructions

## Rol
KullanÄ±cÄ±nÄ±n ilanlarÄ±nÄ± silmekten sorumlusun. Ä°lan silme iÅŸlemlerini gÃ¼venli bir ÅŸekilde gerÃ§ekleÅŸtirirsin.

## Sorumluluklar
1. KullanÄ±cÄ±ya hangi ilanÄ±nÄ± silmek istediÄŸini sor
2. `list_user_listings_tool` ile kullanÄ±cÄ±nÄ±n ilanlarÄ±nÄ± listele
3. KullanÄ±cÄ±ya ilanlarÄ± gÃ¶ster ve hangisini silmek istediÄŸini seÃ§
4. **Silme iÅŸlemini onaylat** (Ã¶nemli!)
5. `delete_listing_tool` ile ilanÄ± sil
6. KullanÄ±cÄ±ya sonucu bildir

## AkÄ±ÅŸ
```
KullanÄ±cÄ±: \"iPhone ilanÄ±mÄ± sil\"
â†“
1. list_user_listings_tool(user_id=\"USER_PHONE\") Ã§aÄŸÄ±r
2. Bulunan ilanlarÄ± kullanÄ±cÄ±ya gÃ¶ster:
   \"Åu ilanlarÄ±nÄ±z var:
   1. iPhone 13 Pro - 25,000 TL
   2. MacBook Air - 40,000 TL\"
3. KullanÄ±cÄ±ya sor: \"Hangisini silmek istiyorsunuz?\"
4. KullanÄ±cÄ±: \"1\"
5. ONAY Ä°STE: \"iPhone 13 Pro ilanÄ±nÄ± silmek istediÄŸinizden emin misiniz? (Evet/HayÄ±r)\"
6. KullanÄ±cÄ±: \"Evet\"
7. delete_listing_tool(listing_id=\"uuid\")
8. \"âœ… iPhone 13 Pro ilanÄ±nÄ±z silindi!\"
```

## Ã–nemli Kurallar
- **MUTLAKA ONAY AL** - Silme iÅŸlemi geri alÄ±namaz!
- Silmeden Ã¶nce MUTLAKA list_user_listings_tool ile ilanlarÄ± listele
- KullanÄ±cÄ±ya hangi ilanÄ± sileceÄŸini net olarak gÃ¶ster
- YanlÄ±ÅŸ silme iÅŸlemlerini Ã¶nle

## Ã–rnek Senaryolar

### Senaryo 1: Tek Ä°lan Silme
```
KullanÄ±cÄ±: \"kanepe ilanÄ±mÄ± sil\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\")
   â†’ Bulunan: [
       {\"id\": \"abc123\", \"title\": \"Kanepe\", \"price\": 20000},
       {\"id\": \"def456\", \"title\": \"Masa\", \"price\": 5000}
     ]

2. KullanÄ±cÄ±ya gÃ¶ster:
   \"Kanepe ilanÄ±nÄ±zÄ± buldum:
   ğŸ“¦ Kanepe - 20,000 TL
   
   Bu ilanÄ± silmek istediÄŸinizden emin misiniz? (Evet/HayÄ±r)\"

3. KullanÄ±cÄ±: \"Evet\"

4. delete_listing_tool(listing_id=\"abc123\")

5. YanÄ±t: \"âœ… Kanepe ilanÄ±nÄ±z silindi!\"
```

### Senaryo 2: Birden Fazla Ä°lan, SeÃ§im Ä°ste
```
KullanÄ±cÄ±: \"iPhone ilanÄ±mÄ± sil\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\")
   â†’ Bulunan: [
       {\"id\": \"aaa\", \"title\": \"iPhone 13 Pro\", \"price\": 25000},
       {\"id\": \"bbb\", \"title\": \"iPhone 12\", \"price\": 18000}
     ]

2. KullanÄ±cÄ±ya gÃ¶ster:
   \"Birden fazla iPhone ilanÄ±nÄ±z var:
   1. iPhone 13 Pro - 25,000 TL
   2. iPhone 12 - 18,000 TL
   
   Hangisini silmek istiyorsunuz? (1 veya 2)\"

3. KullanÄ±cÄ±: \"1\"

4. Onay iste:
   \"iPhone 13 Pro ilanÄ±nÄ± silmek istediÄŸinizden emin misiniz? (Evet/HayÄ±r)\"

5. KullanÄ±cÄ±: \"Evet\"

6. delete_listing_tool(listing_id=\"aaa\")

7. \"âœ… iPhone 13 Pro ilanÄ±nÄ±z silindi!\"
```

### Senaryo 3: Ä°lan BulunamadÄ±
```
KullanÄ±cÄ±: \"laptop ilanÄ±mÄ± sil\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\")
   â†’ count: 0 (hiÃ§ ilan yok)

2. YanÄ±t:
   \"Laptop ilanÄ±nÄ±z bulunamadÄ±. Ä°lanlarÄ±nÄ±zÄ± gÃ¶rmek ister misiniz?\"
```

### Senaryo 4: Ä°ptal Edildi
```
KullanÄ±cÄ±: \"bisiklet ilanÄ±mÄ± sil\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\")
2. Bisiklet ilanÄ±nÄ± gÃ¶ster
3. Onay iste: \"Bisiklet ilanÄ±nÄ± silmek istediÄŸinizden emin misiniz?\"
4. KullanÄ±cÄ±: \"HayÄ±r\" veya \"Ä°ptal\"
5. YanÄ±t: \"Tamam, silme iÅŸlemini iptal ettim. Ä°lanÄ±nÄ±z duruyor.\"
```

### Senaryo 5: TÃ¼m Ä°lanlarÄ± Sil
```
KullanÄ±cÄ±: \"tÃ¼m ilanlarÄ±mÄ± sil\"

AdÄ±mlar:
1. list_user_listings_tool(user_id=\"USER_PHONE\")
   â†’ Bulunan: 5 ilan

2. KullanÄ±cÄ±ya gÃ¶ster:
   \"Toplam 5 ilanÄ±nÄ±z var:
   1. iPhone 13 Pro - 25,000 TL
   2. MacBook Air - 40,000 TL
   3. Kanepe - 20,000 TL
   4. Bisiklet - 3,500 TL
   5. Masa - 5,000 TL
   
   âš ï¸ TÃœM Ä°LANLARINIZI silmek istediÄŸinizden emin misiniz? (Evet/HayÄ±r)\"

3. KullanÄ±cÄ±: \"Evet\"

4. Her ilan iÃ§in delete_listing_tool Ã§aÄŸÄ±r:
   - delete_listing_tool(listing_id=\"1\")
   - delete_listing_tool(listing_id=\"2\")
   - ...

5. \"âœ… TÃ¼m ilanlarÄ±nÄ±z (5 adet) silindi!\"
```

## user_id NasÄ±l Bulunur?
- WhatsApp entegrasyonunda kullanÄ±cÄ±nÄ±n telefon numarasÄ± user_id olarak kullanÄ±lacak
- Åimdilik test iÃ§in: user_id = \"test_user_123\"
- GerÃ§ek ortamda: user_id = WhatsApp phone number (Ã¶rn: \"+905551234567\")

## Hata DurumlarÄ±

### Ä°lan Zaten SilinmiÅŸ
```
delete_listing_tool(listing_id=\"xyz\")
â†’ success: False, status_code: 404

YanÄ±t: \"Bu ilan zaten silinmiÅŸ veya bulunamÄ±yor.\"
```

### Silme Yetkisi Yok
```
delete_listing_tool(listing_id=\"xyz\")
â†’ success: False, error: \"Permission denied\"

YanÄ±t: \"Bu ilanÄ± silme yetkiniz yok (sadece kendi ilanlarÄ±nÄ±zÄ± silebilirsiniz).\"
```

### BaÄŸlantÄ± HatasÄ±
```
delete_listing_tool(listing_id=\"xyz\")
â†’ success: False, status_code: 503

YanÄ±t: \"ÃœzgÃ¼nÃ¼m, ÅŸu anda sunucuya baÄŸlanamÄ±yorum. LÃ¼tfen tekrar deneyin.\"
```

## Tools KullanÄ±m SÄ±rasÄ±
1. **list_user_listings_tool** â†’ KullanÄ±cÄ±nÄ±n ilanlarÄ±nÄ± getir
2. **KullanÄ±cÄ±ya gÃ¶ster ve onay al** â†’ (Tool deÄŸil, sohbet)
3. **delete_listing_tool** â†’ Ä°lanÄ± sil

## Onay MesajlarÄ± (Kritik!)
```
\"âš ï¸ [Ä°lan AdÄ±] ilanÄ±nÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz. (Evet/HayÄ±r)\"
```

## BaÅŸarÄ± MesajlarÄ±
- \"âœ… [Ä°lan AdÄ±] ilanÄ±nÄ±z silindi!\"
- \"âœ… Ä°lan baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±!\"
- \"âœ… TÃ¼m ilanlarÄ±nÄ±z (X adet) silindi!\"

## Ä°ptal MesajlarÄ±
- \"Tamam, silme iÅŸlemini iptal ettim.\"
- \"Ä°lanÄ±nÄ±z duruyor, silme iÅŸlemi yapÄ±lmadÄ±.\"

## GÃ¼venlik KurallarÄ±
1. **Her zaman onay al** - KullanÄ±cÄ± \"Evet\" demeden silme
2. **Net bilgi ver** - Hangi ilanÄ±n silineceÄŸini aÃ§Ä±kÃ§a sÃ¶yle
3. **user_id kontrolÃ¼** - Sadece kullanÄ±cÄ±nÄ±n kendi ilanlarÄ±nÄ± sil (Supabase RLS ile saÄŸlanacak)

## DeleteListingAgent vs CancelListingAgent FarkÄ±
- **DeleteListingAgent**: Ä°lanÄ± tamamen veritabanÄ±ndan SÄ°LER (geri getirilemez)
- **CancelListingAgent**: Ä°lan oluÅŸturma sÃ¼recini iptal eder (taslak halindeki yeni ilan)

## Ã–zet
- KullanÄ±cÄ±nÄ±n ilanlarÄ±nÄ± SÄ°L (delete_listing_tool)
- MUTLAKA onay al
- Net ve gÃ¼venli silme sÃ¼reci
- Hata durumlarÄ±nda kullanÄ±cÄ±yÄ± bilgilendir
""",
  model="gpt-5.1",
  tools=[
    mcp4
  ],
  model_settings=ModelSettings(
    store=True,
    reasoning=Reasoning(
      effort="low",
      summary="auto"
    )
  )
)


class WorkflowInput(BaseModel):
  input_as_text: str


# Main code entrypoint
async def run_workflow(workflow_input: WorkflowInput):
  with trace("PazarGlobal"):
    state = {

    }
    workflow = workflow_input.model_dump()
    conversation_history: list[TResponseInputItem] = [
      {
        "role": "user",
        "content": [
          {
            "type": "input_text",
            "text": workflow["input_as_text"]
          }
        ]
      }
    ]
    guardrails_input_text = workflow["input_as_text"]
    guardrails_result = await run_and_apply_guardrails(guardrails_input_text, guardrails_sanitize_input_config, conversation_history, workflow)
    guardrails_hastripwire = guardrails_result["has_tripwire"]
    guardrails_anonymizedtext = guardrails_result["safe_text"]
    guardrails_output = (guardrails_hastripwire and guardrails_result["fail_output"]) or guardrails_result["pass_output"]
    if guardrails_hastripwire:
      return guardrails_output
    else:
      router_agent_intent_classifier_result_temp = await Runner.run(
        router_agent_intent_classifier,
        input=[
          *conversation_history
        ],
        run_config=RunConfig(trace_metadata={
          "__trace_source__": "agent-builder",
          "workflow_id": "wf_691884cc7e6081908974fe06852942af0249d08cf5054fdb"
        })
      )

      conversation_history.extend([item.to_input_item() for item in router_agent_intent_classifier_result_temp.new_items])

      router_agent_intent_classifier_result = {
        "output_text": router_agent_intent_classifier_result_temp.final_output.json(),
        "output_parsed": router_agent_intent_classifier_result_temp.final_output.model_dump()
      }
      if router_agent_intent_classifier_result["output_parsed"]["intent"] == "create_listing":
        listingagent_result_temp = await Runner.run(
          listingagent,
          input=[
            *conversation_history
          ],
          run_config=RunConfig(trace_metadata={
            "__trace_source__": "agent-builder",
            "workflow_id": "wf_691884cc7e6081908974fe06852942af0249d08cf5054fdb"
          })
        )

        conversation_history.extend([item.to_input_item() for item in listingagent_result_temp.new_items])

        listingagent_result = {
          "output_text": listingagent_result_temp.final_output_as(str)
        }
      elif router_agent_intent_classifier_result["output_parsed"]["intent"] == "update_listing":
        updatelistingagent_result_temp = await Runner.run(
          updatelistingagent,
          input=[
            *conversation_history
          ],
          run_config=RunConfig(trace_metadata={
            "__trace_source__": "agent-builder",
            "workflow_id": "wf_691884cc7e6081908974fe06852942af0249d08cf5054fdb"
          })
        )

        conversation_history.extend([item.to_input_item() for item in updatelistingagent_result_temp.new_items])

        updatelistingagent_result = {
          "output_text": updatelistingagent_result_temp.final_output_as(str)
        }
      elif router_agent_intent_classifier_result["output_parsed"]["intent"] == "publish_listing":
        publishagent_result_temp = await Runner.run(
          publishagent,
          input=[
            *conversation_history
          ],
          run_config=RunConfig(trace_metadata={
            "__trace_source__": "agent-builder",
            "workflow_id": "wf_691884cc7e6081908974fe06852942af0249d08cf5054fdb"
          })
        )

        conversation_history.extend([item.to_input_item() for item in publishagent_result_temp.new_items])

        publishagent_result = {
          "output_text": publishagent_result_temp.final_output_as(str)
        }
      elif router_agent_intent_classifier_result["output_parsed"]["intent"] == "search_product":
        searchagent_result_temp = await Runner.run(
          searchagent,
          input=[
            *conversation_history
          ],
          run_config=RunConfig(trace_metadata={
            "__trace_source__": "agent-builder",
            "workflow_id": "wf_691884cc7e6081908974fe06852942af0249d08cf5054fdb"
          })
        )

        conversation_history.extend([item.to_input_item() for item in searchagent_result_temp.new_items])

        searchagent_result = {
          "output_text": searchagent_result_temp.final_output_as(str)
        }
      elif router_agent_intent_classifier_result["output_parsed"]["intent"] == "small_talk":
        smalltalkagent_result_temp = await Runner.run(
          smalltalkagent,
          input=[
            *conversation_history
          ],
          run_config=RunConfig(trace_metadata={
            "__trace_source__": "agent-builder",
            "workflow_id": "wf_691884cc7e6081908974fe06852942af0249d08cf5054fdb"
          })
        )

        conversation_history.extend([item.to_input_item() for item in smalltalkagent_result_temp.new_items])

        smalltalkagent_result = {
          "output_text": smalltalkagent_result_temp.final_output_as(str)
        }
      elif router_agent_intent_classifier_result["output_parsed"]["intent"] == "cancel":
        cancelagent_result_temp = await Runner.run(
          cancelagent,
          input=[
            *conversation_history
          ],
          run_config=RunConfig(trace_metadata={
            "__trace_source__": "agent-builder",
            "workflow_id": "wf_691884cc7e6081908974fe06852942af0249d08cf5054fdb"
          })
        )

        conversation_history.extend([item.to_input_item() for item in cancelagent_result_temp.new_items])

        cancelagent_result = {
          "output_text": cancelagent_result_temp.final_output_as(str)
        }
      elif router_agent_intent_classifier_result["output_parsed"]["intent"] == "delete_listing":
        deletelistingagent_result_temp = await Runner.run(
          deletelistingagent,
          input=[
            *conversation_history
          ],
          run_config=RunConfig(trace_metadata={
            "__trace_source__": "agent-builder",
            "workflow_id": "wf_691884cc7e6081908974fe06852942af0249d08cf5054fdb"
          })
        )

        conversation_history.extend([item.to_input_item() for item in deletelistingagent_result_temp.new_items])

        deletelistingagent_result = {
          "output_text": deletelistingagent_result_temp.final_output_as(str)
        }
      else:
